#! /bin/bash
if [[ "$#" -ne 3 ]]; then
    echo  "Error: Illegal number of parameters"
    echo  "This is not a conventional ./configure script; it is not generated by GNU autoconf."
    echo \
"Usage: ./configure <path_to_C_compiler> <path_to_static_library_archiver> [1|0]
        To use defaults(/usr/bin/gcc and /usr/bin/ar) specify / for the first two arguments.
	The third argument is DEBUG. 1 turns debegging mode on and disables stripping, while
	0 turns it off, enabling the stripping of binaries. Anything else fails."
    exit 1
fi

if [[ $1 == '/' ]]; then
	CC=/usr/bin/gcc
else
	CC=$1
fi
LD=$CC
if [[ $2 == '/' ]]; then
	AR=/usr/bin/ar
else
	AR=$2
fi

if [[ ! (-f $CC) ]]; then
	echo "Error: compiler $CC does not exist"
	exit 2
fi
if [[ ! (-f $AR) ]]; then
	echo "Error: static library archiver $AR does not exist"
	exit 2
fi
if [[ $3 != 0 && $3 != 1 ]]; then
	echo "Error: DEBUG may only be set to 0 or 1"
	exit 1
fi

$CC -o tests/sanity tests/sanity.c
if [[ ! (-f tests/sanity) ]]; then
	echo "Error: sanity check failed: C compiler $CC could not compile a simple program"
	exit 1
fi
echo "Not testing $AR!"
if [[ $(tests/sanity <<< 43) != 42 ]]; then
	echo "Error: sanity check failed: C compiler compiled wrongly"
	exit 1
fi

if [[ -f Makefile.bkp ]]; then
	rm Makefile
	cp Makefile.bkp Makefile
else
	cat Makefile > Makefile.bkp
fi
sed -i "s|CCOMPILER|$CC|g" Makefile
sed -i "s|LINKER|$LD|g" Makefile
sed -i "s|ARCHIVER|$AR|g" Makefile
sed -i "s|DEBUG|$3|g" Makefile
rm -f tests/sanity
